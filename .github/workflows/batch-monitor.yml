name: Batch Monitor

on:
  schedule:
    # ë§¤ì¼ UTC 10:00 (í•œêµ­ì‹œê°„ 19:00) - ë°°ì¹˜ ì‹¤í–‰ 1ì‹œê°„ í›„ ì²´í¬
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Batch Status
        run: |
          echo "ğŸ” Checking batch execution status..."
          
          response=$(curl -s https://patchlog.vercel.app/api/batch-status)
          echo "ğŸ“Š Batch Status Response:"
          echo "$response" | jq '.'
          
          # ì˜¤ëŠ˜ ë°°ì¹˜ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
          today_executions=$(echo "$response" | jq -r '.todayExecutions // 0')
          healthy=$(echo "$response" | jq -r '.healthy // false')
          
          echo "Today executions: $today_executions"
          echo "Healthy: $healthy"
          
          if [ "$healthy" = "false" ] || [ "$today_executions" -eq 0 ]; then
            echo "âŒ Batch execution failed or missing today!"
            echo "ğŸš¨ Manual intervention required"
            
            # ì‹¤íŒ¨ ì•Œë¦¼ (ì—¬ê¸°ì— Slack, Discord ë“± ì›¹í›… ì¶”ê°€ ê°€ëŠ¥)
            echo "::warning::Batch execution failed today. Check logs and trigger manual batch if needed."
            
            exit 1
          else
            echo "âœ… Batch execution healthy"
          fi

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Batch Execution Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Batch ì‹¤í–‰ ì‹¤íŒ¨ ê°ì§€
            
            **ë‚ ì§œ**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            
            ### ë¬¸ì œ
            - ì˜¤ëŠ˜ ë°°ì¹˜ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            
            ### í™•ì¸ ì‚¬í•­
            1. [Vercel ëŒ€ì‹œë³´ë“œ](https://vercel.com/dashboard) â†’ Functions â†’ Cron Jobs ìƒíƒœ í™•ì¸
            2. [ë°°ì¹˜ ìƒíƒœ API](https://patchlog.vercel.app/api/batch-status) í™•ì¸
            3. ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰: \`curl -X POST https://patchlog.vercel.app/api/marvel-batch -H "x-vercel-cron: 1" -H "user-agent: vercel-cron/1.0"\`
            
            ### Auto-generated
            ì´ ì´ìŠˆëŠ” ë°°ì¹˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            `;
            
            // ê¸°ì¡´ ì˜¤í”ˆëœ ë°°ì¹˜ ì‹¤íŒ¨ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'batch-failure'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['batch-failure', 'bug', 'high-priority']
              });
            }